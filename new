/********************
 *  Author : Shivam Cahturvedi                          *
 *  Date   : 13/8/22                                    *              
 *  Name   : Data_Insertion_Api                         *
 ********************/

//Including Necessary Modules

const express    = require('express')              ;
const app        = express()                       ;

const upload     = require('express-fileupload')   ;
const exphbs     = require('express-handlebars')   ;
const mysql      = require('mysql')                ;
const bodyparser = require('body-parser')          ;
const Buffer     = require('buffer').Buffer        ;

//Setting up the modules & View engine

//? No need for this just install postman
// app.use(upload());
// app.engine('hbs', exphbs.engine({extname: '.hbs' }));
// app.set('view engine', 'hbs' );

//Creating server Connection

app.listen("8080", () =>{console.log("Connected to Server on port: 8080");});
app.use(bodyparser.urlencoded({ extended: true}));

//Creating Mysql-Databse connection

const db = mysql.createConnection({
    host        : "localhost"   ,
    user        : "root"        ,
    password    : ""            ,
    database    : "api_database",
    table       : "entries"
});

db.connect((err) => {
    if(err) throw err;
    console.log("Database Connected Successfully!");
});

//Sent data with post method

//? Login api and 
app.post("/login", function (req, res) {
    
    //Assigning GLOBAL data to local variable for sql query
    
        let bill        = req.files?.Bill;
        let receiver    = req.files?.Receiver;
        let photo       = req.files?.Photo;
    
    //Assigning buffer data
    
        let billbuf     = bill.data;
        let receiverbuf = receiver.data;
        let photobuf    = photo.data;
    
    //Converting buffer data to json & Assigning 
        
        let billdata    = billbuf.toJSON();
        let receiverdata= receiverbuf.toJSON();
        let photodata   = photobuf.toJSON();
    
    //Assigning sql query & calling it
    
    
    
    //? Please take some more variables and for now just insert string in all 3 images.
        let sql = `INSERT INTO entries (lr_number, d_person, bill, receiver, photo_id,remarks,status,location,signature) VALUES (${req.lrNo}, '${req.name}', '${billdata}', '${receiverdata}', '${photodata}')`;
    
        db.query(sql, (err, result) => {
            if(err) throw err;
            
            console.log("New entry created!\n");
        });
    
       //? return some response like request completed successfully                                             ;
        
    });


app.post("/create/entry", function (req, res) {
    
//Assigning GLOBAL data to local variable for sql query

    let bill        = req.files?.Bill;
    let receiver    = req.files?.Receiver;
    let photo       = req.files?.Photo;

//Assigning buffer data

    let billbuf     = bill.data;
    let receiverbuf = receiver.data;
    let photobuf    = photo.data;

//Converting buffer data to json & Assigning 
    
    let billdata    = billbuf.toJSON();
    let receiverdata= receiverbuf.toJSON();
    let photodata   = photobuf.toJSON();

//Assigning sql query & calling it



//? Please take some more variables and for now just insert string in all 3 images.
    let sql = `INSERT INTO entries (lr_number, d_person, bill, receiver, photo_id,remarks,status,location,signature) VALUES (${req.lrNo}, '${req.name}', '${billdata}', '${receiverdata}', '${photodata}')`;

    db.query(sql, (err, result) => {
        if(err) throw err;
        
        console.log("New entry created!\n");
    });

   //? return some response like request completed successfully                                             ;
    
});


//? get all api to get all the entries

app.get("get/all/enrty", function (req, res) {
    
    //Assigning GLOBAL data to local variable for sql query

    // ? Just selct all data and return to a json Response
    
        let bill        = req.files?.Bill;
        let receiver    = req.files?.Receiver;
        let photo       = req.files?.Photo;
    
    //Assigning buffer data
    
        let billbuf     = bill.data;
        let receiverbuf = receiver.data;
        let photobuf    = photo.data;
    
    //Converting buffer data to json & Assigning 
        
        let billdata    = billbuf.toJSON();
        let receiverdata= receiverbuf.toJSON();
        let photodata   = photobuf.toJSON();
    
    //Assigning sql query & calling it
    
        let sql = `INSERT INTO entries (lr_number, d_person, bill, receiver, photo_id,remarks,status,location,signature) VALUES (${req.lrNo}, '${req.name}', '${billdata}', '${receiverdata}', '${photodata}')`;
    
        db.query(sql, (err, result) => {
            if(err) throw err;
            
            console.log("New entry created!\n");
        });
    
                                                    ;
        
    })